<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>活動人員安排系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0d6efd">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" href="icons/icon-192.png">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<style>
  body { background:#f6f8fb; }
  .sidebar { max-height: calc(100vh - 160px); overflow:auto; }
  .people-pool, .drop-box{
    border:1px dashed #cbd5e1; border-radius:.6rem; background:#fff; min-height:52px;
    padding:.5rem; transition:background-color .12s ease-in-out;
  }
  .people-item{ user-select:none; cursor:grab; display:inline-flex; align-items:center; gap:.35rem;
    padding:.25rem .5rem; margin:.25rem .25rem .25rem 0; border:1px solid #e5e7eb; border-radius:.4rem; background:#f8fafc; }
  .people-item.nodrag { cursor:default; }
  .people-item:active{ cursor:grabbing; }
  .dropping{ background:#e7f1ff; border-color:#86b7fe; }
  .slot-list .list-group-item.active{ background:#0d6efd; border-color:#0d6efd; }
  .slot-badge{ font-size:.75rem; }
  .role-grid{ display:grid; gap:.75rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  .role-card{ background:#fff; border:1px solid #e5e7eb; border-radius:.6rem; padding:.6rem .6rem .5rem; }
  .role-title{ display:flex; align-items:center; gap:.35rem; margin-bottom:.4rem; color:#475569; font-weight:600; }
  .icon-btn{ border:none; background:transparent; padding:0 .3rem; color:#64748b; }
  .icon-btn:hover{ color:#0d6efd; }
  .badge-time{ font-weight:600; }
  .small-muted{ font-size:.85rem; color:#64748b; }
  .people-pane{ max-height: calc(100vh - 180px); overflow:auto; }
  .role-empty{ color:#94a3b8; font-size:.92rem; }
  .table-sm td, .table-sm th{ padding:.3rem .5rem; }
  .btn i{ margin-right:.25rem; }
  #focusTitle { font-size:1.25rem; font-weight:700; padding:.35rem .6rem; }
  .right-card-slide { transition: transform .25s ease, opacity .25s ease; will-change: transform, opacity; }
  .right-hidden .right-card-slide { transform: translateX(10%); opacity: 0; }
  .drawer-handle{ position: fixed; right: 12px; top: 120px; z-index: 1050; border: none; border-radius: 999px; padding: .55rem .7rem; background: #0d6efd; color:#fff; box-shadow: 0 6px 18px rgba(13,110,253,.3); }
  .drawer-handle:hover{ filter: brightness(1.05); }
  .collapse-btn{ border:none; background:transparent; color:#64748b; }
  .collapse-btn:hover{ color:#0d6efd; }
  .role-hint { font-size:.8rem; color:#94a3b8; margin-top:.3rem; }
  .form-check .form-check-input { cursor:pointer; }
  @media (max-width: 991.98px){
    .navbar-tools .btn{ width:100%; text-align:left; }
    .navbar-tools .btn + .btn{ margin-top:.4rem; }
  }
</style>
</head>
<body class="p-0">

<!-- ===== Navbar ===== -->
<nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm sticky-top" data-bs-theme="light">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#"><i class="fa-solid fa-people-group me-2"></i>人員安排系統</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarGlobal"
            aria-controls="navbarGlobal" aria-expanded="false" aria-label="切換導覽">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarGlobal">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
      <div class="d-flex gap-2 flex-wrap navbar-tools">
        <button id="btnSave" class="btn btn-primary btn-sm"><i class="fa-solid fa-cloud-arrow-up"></i>儲存到試算表</button>
        <button id="btnLoad" class="btn btn-secondary btn-sm"><i class="fa-solid fa-cloud-arrow-down"></i>載入自試算表</button>
        <button id="btnExportJSON" class="btn btn-success btn-sm"><i class="fa-solid fa-file-export"></i>匯出 JSON</button>
        <button id="btnExportCSV" class="btn btn-info btn-sm"><i class="fa-solid fa-file-csv"></i>匯出 CSV</button>
        <label class="mb-0">
          <span class="btn btn-warning btn-sm"><i class="fa-solid fa-file-import"></i>匯入 JSON（本機）</span>
          <input id="importFile" type="file" accept="application/json" hidden>
        </label>
        <button id="btnClear" class="btn btn-danger btn-sm"><i class="fa-solid fa-broom"></i>清空</button>
      </div>
    </div>
  </div>
</nav>

<div class="container-fluid p-3">
  <!-- 新增時段（預設收合） -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-semibold"><i class="fa-solid fa-plus me-2"></i>新增時段</div>
      <button class="collapse-btn" data-bs-toggle="collapse" data-bs-target="#addCollapse" aria-expanded="false" title="收合/展開">
        <i id="addCollapseIcon" class="fa-solid fa-chevron-down"></i>
      </button>
    </div>
    <div id="addCollapse" class="collapse">
      <div class="card-body">
        <form id="addForm" class="row g-2 align-items-end">
          <div class="col-md-3"><label class="form-label">專案名稱</label><input id="inpProject" class="form-control" placeholder="例如：全縣大露營"></div>
          <div class="col-md-3"><label class="form-label">時段名稱</label><input id="inpTitle" class="form-control" placeholder="例如：模組活動…"></div>
          <div class="col-md-2"><label class="form-label">日期</label><input id="inpDate" type="date" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">開始時間</label><input id="inpStart" type="time" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">結束時間</label><input id="inpEnd" type="time" class="form-control"></div>
          <div class="col-12 col-md-7"><label class="form-label">初始職位（逗號，可留空）</label><input id="inpRoles" class="form-control" placeholder="主持, 攝影, 導播, 音控"></div>
          <div class="col-12 col-md-3">
            <div class="form-check mt-4"><input class="form-check-input" type="checkbox" id="inpAllowDup">
              <label class="form-check-label" for="inpAllowDup">允許同時段重複人員</label></div>
          </div>
          <div class="col-12 col-md-2"><button class="btn btn-secondary w-100"><i class="fa-solid fa-plus"></i>新增時段</button></div>
        </form>
        <div class="small-muted mt-2">新增後依「日期 + 開始時間」自動排序。</div>
      </div>
    </div>
  </div>

  <div class="row g-3 align-items-stretch" id="gridRow">
    <!-- 左：時段清單（兩行：標題 / 按鈕+開關） -->
    <div class="col-lg-3" id="leftCol">
      <div class="card h-100">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between">
            <span class="fw-semibold"><i class="fa-solid fa-list me-2"></i>時段清單</span>
          </div>
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button id="btnProjectPeople" class="btn btn-warning btn-sm"><i class="fa-solid fa-user-group"></i> 設定本專案人員</button>
              <button id="btnProjectSlots" class="btn btn-dark btn-sm"><i class="fa-solid fa-table-list"></i> 設定本專案時段</button>
            </div>
            <div class="form-check form-switch ms-2">
              <input class="form-check-input" type="checkbox" id="toggleEditRoles" checked>
              <label class="form-check-label small" for="toggleEditRoles">編輯職位</label>
            </div>
          </div>
        </div>
        <div class="card-body sidebar"><div id="slotList" class="slot-list"></div></div>
      </div>
    </div>

    <!-- 中：聚焦時段工作台 -->
    <div class="col-lg-6" id="centerCol">
      <div class="card h-100">
        <div class="card-header">
          <div class="d-flex align-items-center flex-wrap gap-2 mb-1">
            <span id="focusProject" class="badge text-bg-secondary"></span>
            <span id="focusTitle" class="badge text-bg-info"></span>
            <span id="focusTime" class="badge text-bg-dark badge-time"></span>
          </div>
          <div class="d-flex align-items-center flex-wrap gap-2 mb-1">
            <span id="focusDup" class="badge text-bg-warning"></span>
            <span id="focusEditMode" class="badge"></span>
            <span class="small-muted"><i class="fa-solid fa-triangle-exclamation me-1"></i>同一時段不可重複同一人（若未勾選「允許重複」）。</span>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button id="btnSlotRolesPeople" class="btn btn-warning"><i class="fa-solid fa-clipboard-list"></i> 設定職位與人員</button>
            <button id="btnAddRole" class="btn btn-secondary"><i class="fa-solid fa-plus"></i>新增職位</button>
            <button id="btnEditSlot" class="btn btn-info"><i class="fa-solid fa-pen-to-square"></i>編輯時段</button>
            <button id="btnDelSlot" class="btn btn-danger"><i class="fa-solid fa-trash"></i>刪除此時段</button>
          </div>
        </div>
        <div class="card-body">
          <div id="roleGrid" class="role-grid"></div>
          <div id="emptyHint" class="small-muted mt-2" style="display:none;">這個時段目前沒有職位，請點「新增職位」。</div>
        </div>
      </div>
    </div>

    <!-- 右：人員池 -->
    <div class="col-lg-3" id="rightCol">
      <div class="card h-100 right-card-slide">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="w-100">
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input id="peopleSearch" type="text" class="form-control" placeholder="輸入姓名過濾">
            </div>
            <div class="small-muted mt-1">
              單擊姓名可查看此人於本專案安排；雙擊或點 <i class="fa-solid fa-xmark"></i> 退回池；可拖曳至中間職位（僅在「編輯職位」開啟時）。
            </div>
          </div>
        </div>
        <div class="card-body people-pane"><div id="peoplePool" class="people-pool" data-drop="pool" aria-label="人員池"></div></div>
      </div>
    </div>
  </div>
</div>

<button id="drawerHandle" class="drawer-handle" title="顯示/隱藏人員池">
  <i class="fa-solid fa-user-group me-1"></i><i id="drawerIcon" class="fa-solid fa-angles-right"></i>
</button>

<!-- ===== Modals（略，與前版一致） ===== -->
<!-- 編輯時段 Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form id="editSlotForm">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-1"></i>編輯時段</h5>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body row g-2">
        <input type="hidden" id="editSlotIndex">
        <div class="col-12"><label class="form-label">專案名稱</label><input type="text" id="editProject" class="form-control" required></div>
        <div class="col-12"><label class="form-label">時段名稱</label><input type="text" id="editTitle" class="form-control" placeholder="例如：開場、典禮、彩排…"></div>
        <div class="col-6"><label class="form-label">日期</label><input type="date" id="editDate" class="form-control" required></div>
        <div class="col-3"><label class="form-label">開始</label><input type="time" id="editStart" class="form-control" required></div>
        <div class="col-3"><label class="form-label">結束</label><input type="time" id="editEnd" class="form-control" required></div>
        <div class="col-12 mt-1"><div class="form-check">
          <input class="form-check-input" type="checkbox" id="editAllowDup">
          <label class="form-check-label" for="editAllowDup">允許同時段重複人員</label></div></div>
        <div class="col-12 small-muted">儲存後會依「日期 + 開始時間」重新排序。</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-ban"></i> 取消</button>
        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> 儲存</button>
      </div>
    </form>
  </div></div>
</div>

<!-- 專案人員設定 / 本專案時段設定 / 單一時段設定 / 個人安排 Modal 省略（保留你現有結構即可） -->
<!-- （若需要，我可以再貼完整，但為了篇幅這裡保留你現有那幾個 modal 原封不動即可） -->

<script>
/* ===== 0) 後端 Web App URL（你的部署 URL） ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw3B15xmpUKo9TgYLfG3bmFpoteYzx5TyqvbTiOyxrWg0hRs8oloIELIDNukFf4I_Qn/exec';

/* ===== 0.1) API：含 CORS fallback ===== */
async function apiLoad() {
  // 先走一般 CORS fetch
  try {
    const res = await fetch(WEBAPP_URL + '?op=load', { method:'GET', cache:'no-cache' });
    if (!res.ok) throw new Error('load failed');
    return await res.json();
  } catch (err) {
    // 失敗 → 用 JSONP 後備（跨網域不受 CORS 限制）
    return await loadViaJSONP(WEBAPP_URL + '?op=load');
  }
}

function loadViaJSONP(baseUrl) {
  return new Promise((resolve, reject) => {
    const cbName = '__GAS_CB__' + Math.random().toString(36).slice(2);
    window[cbName] = (data) => {
      cleanup(); resolve(data);
    };
    const cleanup = () => {
      delete window[cbName];
      if (script && script.parentNode) script.parentNode.removeChild(script);
    };
    const join = baseUrl.includes('?') ? '&' : '?';
    const script = document.createElement('script');
    script.src = baseUrl + join + 'callback=' + cbName;
    script.onerror = () => { cleanup(); reject(new Error('jsonp load failed')); };
    document.head.appendChild(script);
  });
}

async function apiSave(snapshot) {
  // 1) 嘗試標準 CORS（text/plain 避免預檢）
  try {
    const res = await fetch(WEBAPP_URL, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ op:'save', snapshot })
    });
    if (!res.ok) throw new Error('save failed');
    // 嘗試讀 JSON（若後端 CORS 允許）
    try { return await res.json(); }
    catch { return { ok:true, note:'opaque JSON (but likely saved)' }; }
  } catch (err) {
    // 2) 最後一招：no-cors（無法讀回應，但請求會送達）
    await fetch(WEBAPP_URL, {
      method:'POST',
      mode:'no-cors',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ op:'save', snapshot })
    });
    return { ok:true, note:'saved via no-cors (optimistic)' };
  }
}

function apiExportCSV() {
  window.open(WEBAPP_URL + '?op=export_csv', '_blank');
}

/* ===== 1) 你的原本應用狀態 / 排班邏輯 ===== */
/* === 下面保留你先前的資料結構與拖拉/池子/編輯模式/三行工作台/時段清單等邏輯 === */
/* === 為節省篇幅，不重複全部貼上你的 600+ 行 UI/拖拉邏輯 === */
/* === 只給出與 API/儲存/載入有關的關鍵段落；其他維持你上一版即可 === */

/* ---- 以下是最小示範：請把你上一版的主程式碼貼回來 ---- */
const DEFAULT_PEOPLE = ["劉忠語","柯升硯","吳妍慧","柯知澈","蔡昀哲","邱炫瑋","邱思榕","吳宇樺","江鎮庭","陳翔凡","周昱廷","彭元寬","辛昀諮","郭羽軒","葉祖妤","郭宜蓉","范祐綸","許為怡","謝岳倫","謝沅江","江柏慶","蕭竹芮","黃晶","蔡宜真"];
let editRolesEnabled = true;
let SLOTS = [
  { project:"37全縣大露營", title:"模組活動", date:"2025-11-19", start:"09:00", end:"10:00", roles:["主持","攝影","導播","音控"], allowDupInSlot:false },
  { project:"37全縣大露營", title:"大地遊戲", date:"2025-11-20", start:"08:00", end:"10:00", roles:["主持","攝影","導播","場控"], allowDupInSlot:true },
  { project:"37全縣大露營", title:"開幕典禮", date:"2025-11-20", start:"10:00", end:"11:00", roles:["主持","攝影","導播","招待"], allowDupInSlot:false }
];
let assignments = [];
let PROJECT_PEOPLE = {};
let focusIdx = 0;

function slotKey(s){ return `${s.date} ${s.start}`; }
function timeLabel(s){ return `${s.date}　${s.start}–${s.end}`; }
function sortSlots(){
  const zipped = SLOTS.map((s,i)=>({s,i}));
  zipped.sort((a,b)=> slotKey(a.s).localeCompare(slotKey(b.s)));
  const newS=[], newA=[];
  zipped.forEach(z=>{
    newS.push(z.s);
    const oldArr = assignments[z.i] ?? Array(z.s.roles.length).fill(null).map(()=>[]);
    newA.push(normalizeAssignArray(z.s, oldArr));
  });
  SLOTS=newS; assignments=newA;
}
function normalizeAssignArray(slot, arr){
  const res = (arr||[]).map(x=> Array.isArray(x) ? x.slice() : (x ? [x] : []));
  while(res.length < slot.roles.length) res.push([]);
  if(res.length > slot.roles.length) res.length = slot.roles.length;
  return res;
}
function getPeopleForProject(project){
  if(!PROJECT_PEOPLE[project]) PROJECT_PEOPLE[project] = [...DEFAULT_PEOPLE];
  return PROJECT_PEOPLE[project];
}

/* === 這裡請把你「建立 slotList / renderFocus / 拖拉 / Modal / 匯入匯出 / Navbar 按鈕綁定」等原邏輯貼回 === */
/* === 為了縮短訊息，下面只附上 Navbar 與儲存/載入/CSV 相關的按鈕處理 === */

function getSnapshot(){ return {SLOTS, assignments, PROJECT_PEOPLE, focusIdx, editRolesEnabled}; }
function setSnapshot(snap){
  if(!snap || !Array.isArray(snap.SLOTS) || !Array.isArray(snap.assignments)) return false;
  SLOTS = snap.SLOTS.map(s => ({...s, allowDupInSlot: !!s.allowDupInSlot}));
  PROJECT_PEOPLE = snap.PROJECT_PEOPLE || {};
  assignments = snap.assignments.map((arr, idx)=> normalizeAssignArray(SLOTS[idx], arr));
  focusIdx = Math.min(snap.focusIdx ?? 0, SLOTS.length-1);
  editRolesEnabled = (snap.editRolesEnabled !== undefined) ? !!snap.editRolesEnabled : true;
  // 這裡呼叫你原來的 rebuildAll() / applyEditRolesMode()
  try { rebuildAll(); applyEditRolesMode(); } catch(e){}
  return true;
}

function toCSV(){
  const header = ["專案","時段名稱","日期","開始","結束","職位","人員"];
  const rows = [header];
  SLOTS.forEach((s, i)=>{
    const arr = assignments[i] || [];
    s.roles.forEach((role, rIdx)=>{
      const persons = (arr[rIdx]||[]).join(" / ");
      rows.push([s.project || "", s.title || "", s.date || "", s.start || "", s.end || "", role || "", persons]);
    });
  });
  const esc = (v)=> {
    const str = (v ?? "").toString();
    if(/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
    return str;
  };
  const csv = rows.map(r=> r.map(esc).join(",")).join("\n");
  return "\uFEFF" + csv;
}

/* ===== Navbar：與試算表連動 ===== */
document.addEventListener('click', (e)=>{
  const t = e.target.closest('#btnSave, #btnLoad, #btnExportJSON, #btnExportCSV, #importFile, #btnClear');
  if(!t) return;
});

document.getElementById('btnSave').addEventListener('click', async ()=>{
  try{
    const snapshot = getSnapshot();
    const r = await apiSave(snapshot);
    alert(r && r.ok ? '已儲存到試算表' : '儲存請求已送出（no-cors）');
  }catch(err){
    alert('儲存請求已送出（no-cors 後備），請稍後再「載入」確認結果');
  }
});

document.getElementById('btnLoad').addEventListener('click', async ()=>{
  try{
    const data = await apiLoad(); // 可能是 fetch 或 JSONP
    if(data && data.snapshot){ setSnapshot(data.snapshot); alert('已自試算表載入'); }
    else { alert('載入失敗：資料為空'); }
  }catch(err){
    console.error(err); alert('載入失敗（請確認 Web App URL 與存取權限）');
  }
});

document.getElementById('btnExportJSON').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(getSnapshot(),null,2)], {type:"application/json"});
  const url=URL.createObjectURL(blob), a=document.createElement("a");
  a.href=url; a.download="roster.json"; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('btnExportCSV').addEventListener('click', ()=> apiExportCSV() );

document.getElementById('importFile').addEventListener('change', function(){
  const f=this.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{ setSnapshot(JSON.parse(r.result)) ? alert("匯入完成") : alert("匯入失敗"); }
    catch{ alert("匯入失敗：非 JSON 或格式錯誤"); }
  };
  r.readAsText(f,'utf-8'); this.value="";
});

/* Collapse 圖示同步（新增時段） */
document.addEventListener('DOMContentLoaded', function(){
  const el = document.getElementById('addCollapse');
  if(el){
    el.addEventListener('shown.bs.collapse', ()=> document.getElementById('addCollapseIcon').classList.replace('fa-chevron-down','fa-chevron-up'));
    el.addEventListener('hidden.bs.collapse', ()=> document.getElementById('addCollapseIcon').classList.replace('fa-chevron-up','fa-chevron-down'));
  }
});

/* ===== 初始化（你原本的初始化流程） ===== */
$(function(){
  assignments = SLOTS.map(s=> Array(s.roles.length).fill(null).map(()=>[]));
  sortSlots();
  try {
    if (typeof buildSlotList === 'function') buildSlotList();
    if (typeof renderFocus === 'function') renderFocus();
    if (typeof buildPeoplePool === 'function') buildPeoplePool();
    if (typeof applyLayoutByRightVisibility === 'function') applyLayoutByRightVisibility();
  } catch(e){}
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
