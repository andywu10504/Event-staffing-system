<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>活動人員安排系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0d6efd">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<style>
  body { background:#f6f8fb; }
  .sidebar { max-height: calc(100vh - 160px); overflow:auto; }
  .people-pool, .drop-box{
    border:1px dashed #cbd5e1; border-radius:.6rem; background:#fff; min-height:52px;
    padding:.5rem; transition:background-color .12s ease-in-out;
  }
  .people-item{
    user-select:none; cursor:grab; display:inline-flex; align-items:center; gap:.35rem;
    padding:.25rem .5rem; margin:.25rem .25rem .25rem 0; border:1px solid #e5e7eb; border-radius:.4rem; background:#f8fafc;
  }
  .people-item.nodrag { cursor:default; }
  .people-item:active{ cursor:grabbing; }
  .dropping{ background:#e7f1ff; border-color:#86b7fe; }
  .slot-list .list-group-item.active{ background:#0d6efd; border-color:#0d6efd; }
  .slot-badge{ font-size:.75rem; }
  .role-grid{
    display:grid; gap:.75rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
  .role-card{ background:#fff; border:1px solid #e5e7eb; border-radius:.6rem; padding:.6rem .6rem .5rem; }
  .role-title{ display:flex; align-items:center; gap:.35rem; margin-bottom:.4rem; color:#475569; font-weight:600; }
  .icon-btn{ border:none; background:transparent; padding:0 .3rem; color:#64748b; }
  .icon-btn:hover{ color:#0d6efd; }
  .badge-time{ font-weight:600; }
  .small-muted{ font-size:.85rem; color:#64748b; }
  .people-pane{ max-height: calc(100vh - 180px); overflow:auto; }
  .role-empty{ color:#94a3b8; font-size:.92rem; }
  .table-sm td, .table-sm th{ padding:.3rem .5rem; }
  .btn i{ margin-right:.25rem; }
  #focusTitle { font-size:1.25rem; font-weight:700; padding:.35rem .6rem; }
  .right-card-slide { transition: transform .25s ease, opacity .25s ease; will-change: transform, opacity; }
  .right-hidden .right-card-slide { transform: translateX(10%); opacity: 0; }
  .drawer-handle{
    position: fixed; right: 12px; top: 120px; z-index: 1050;
    border: none; border-radius: 999px; padding: .55rem .7rem;
    background: #0d6efd; color:#fff; box-shadow: 0 6px 18px rgba(13,110,253,.3);
  }
  .drawer-handle:hover{ filter: brightness(1.05); }
  .collapse-btn{ border:none; background:transparent; color:#64748b; }
  .collapse-btn:hover{ color:#0d6efd; }
  .role-hint { font-size:.8rem; color:#94a3b8; margin-top:.3rem; }
  .form-check .form-check-input { cursor:pointer; }

  /* Navbar 補強：右側工具按鈕群組在小螢幕改垂直 */
  @media (max-width: 991.98px){
    .navbar-tools .btn{ width:100%; text-align:left; }
    .navbar-tools .btn + .btn{ margin-top:.4rem; }
  }
</style>
</head>
<body class="p-0">

<!-- ===== 全域工具列：Navbar ===== -->
<nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm sticky-top" data-bs-theme="light">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#">
      <i class="fa-solid fa-people-group me-2"></i>人員安排系統
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarGlobal"
            aria-controls="navbarGlobal" aria-expanded="false" aria-label="切換導覽">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarGlobal">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
      <div class="d-flex gap-2 flex-wrap navbar-tools">
        <button id="btnSave" class="btn btn-primary btn-sm"><i class="fa-solid fa-floppy-disk"></i>儲存</button>
        <button id="btnLoad" class="btn btn-secondary btn-sm"><i class="fa-solid fa-rotate"></i>載入</button>
        <button id="btnExportJSON" class="btn btn-success btn-sm"><i class="fa-solid fa-file-export"></i>匯出 JSON</button>
        <button id="btnExportCSV" class="btn btn-info btn-sm"><i class="fa-solid fa-file-csv"></i>匯出 CSV</button>
        <label class="mb-0">
          <span class="btn btn-warning btn-sm"><i class="fa-solid fa-file-import"></i>匯入 JSON</span>
          <input id="importFile" type="file" accept="application/json" hidden>
        </label>
        <button id="btnClear" class="btn btn-danger btn-sm"><i class="fa-solid fa-broom"></i>清空</button>
      </div>
    </div>
  </div>
</nav>

<div class="container-fluid p-3">
  <!-- 新增時段（預設收合） -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-semibold"><i class="fa-solid fa-plus me-2"></i>新增時段</div>
      <button class="collapse-btn" data-bs-toggle="collapse" data-bs-target="#addCollapse" aria-expanded="false" title="收合/展開">
        <i id="addCollapseIcon" class="fa-solid fa-chevron-down"></i>
      </button>
    </div>
    <div id="addCollapse" class="collapse">
      <div class="card-body">
        <form id="addForm" class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">專案名稱</label>
            <input id="inpProject" class="form-control" placeholder="例如：全縣大露營">
          </div>
          <div class="col-md-3">
            <label class="form-label">時段名稱</label>
            <input id="inpTitle" class="form-control" placeholder="例如：模組活動…">
          </div>
          <div class="col-md-2">
            <label class="form-label">日期</label>
            <input id="inpDate" type="date" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">開始時間</label>
            <input id="inpStart" type="time" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">結束時間</label>
            <input id="inpEnd" type="time" class="form-control">
          </div>
          <div class="col-12 col-md-7">
            <label class="form-label">初始職位（逗號，可留空）</label>
            <input id="inpRoles" class="form-control" placeholder="主持, 攝影, 導播, 音控">
          </div>
          <div class="col-12 col-md-3">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="inpAllowDup">
              <label class="form-check-label" for="inpAllowDup">允許同時段重複人員</label>
            </div>
          </div>
          <div class="col-12 col-md-2">
            <button class="btn btn-secondary w-100"><i class="fa-solid fa-plus"></i>新增時段</button>
          </div>
        </form>
        <div class="small-muted mt-2">新增後依「日期 + 開始時間」自動排序。</div>
      </div>
    </div>
  </div>

  <div class="row g-3 align-items-stretch" id="gridRow">
    <!-- 左：時段清單 -->
    <div class="col-lg-3" id="leftCol">
      <div class="card h-100">
        <div class="card-header">
          <!-- 第1行：只放標題 -->
          <div class="d-flex align-items-center justify-content-between">
            <span class="fw-semibold"><i class="fa-solid fa-list me-2"></i>時段清單</span>
          </div>
          <!-- 第2行：按鈕 + 開關 -->
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button id="btnProjectPeople" class="btn btn-warning btn-sm">
                <i class="fa-solid fa-user-group"></i> 設定本專案人員
              </button>
              <button id="btnProjectSlots" class="btn btn-dark btn-sm">
                <i class="fa-solid fa-table-list"></i> 設定本專案時段
              </button>
            </div>
            <div class="form-check form-switch ms-2">
              <input class="form-check-input" type="checkbox" id="toggleEditRoles" checked>
              <label class="form-check-label small" for="toggleEditRoles">編輯職位</label>
            </div>
          </div>
        </div>
        <div class="card-body sidebar">
          <div id="slotList" class="slot-list"></div>
        </div>
      </div>
    </div>

    <!-- 中：聚焦時段工作台（按鈕在第三行） -->
    <div class="col-lg-6" id="centerCol">
      <div class="card h-100">
        <div class="card-header">
          <!-- 第1行 -->
          <div class="d-flex align-items-center flex-wrap gap-2 mb-1">
            <span id="focusProject" class="badge text-bg-secondary"></span>
            <span id="focusTitle" class="badge text-bg-info"></span>
            <span id="focusTime" class="badge text-bg-dark badge-time"></span>
          </div>
          <!-- 第2行 -->
          <div class="d-flex align-items-center flex-wrap gap-2 mb-1">
            <span id="focusDup" class="badge text-bg-warning"></span>
            <span id="focusEditMode" class="badge"></span>
            <span class="small-muted"><i class="fa-solid fa-triangle-exclamation me-1"></i>同一時段不可重複同一人（若未勾選「允許重複」）。</span>
          </div>
          <!-- 第3行 -->
          <div class="d-flex flex-wrap gap-2">
            <button id="btnSlotRolesPeople" class="btn btn-warning">
              <i class="fa-solid fa-clipboard-list"></i> 設定職位與人員
            </button>
            <button id="btnAddRole" class="btn btn-secondary"><i class="fa-solid fa-plus"></i>新增職位</button>
            <button id="btnEditSlot" class="btn btn-info"><i class="fa-solid fa-pen-to-square"></i>編輯時段</button>
            <button id="btnDelSlot" class="btn btn-danger"><i class="fa-solid fa-trash"></i>刪除此時段</button>
          </div>
        </div>
        <div class="card-body">
          <div id="roleGrid" class="role-grid"></div>
          <div id="emptyHint" class="small-muted mt-2" style="display:none;">這個時段目前沒有職位，請點「新增職位」。</div>
        </div>
      </div>
    </div>

    <!-- 右：人員池 -->
    <div class="col-lg-3" id="rightCol">
      <div class="card h-100 right-card-slide">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="w-100">
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input id="peopleSearch" type="text" class="form-control" placeholder="輸入姓名過濾">
            </div>
            <div class="small-muted mt-1">
              單擊姓名可查看此人於本專案安排；雙擊或點 <i class="fa-solid fa-xmark"></i> 退回池；可拖曳至中間職位（僅在「編輯職位」開啟時）。
            </div>
          </div>
        </div>
        <div class="card-body people-pane">
          <div id="peoplePool" class="people-pool" data-drop="pool" aria-label="人員池"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 右側浮動把手 -->
<button id="drawerHandle" class="drawer-handle" title="顯示/隱藏人員池">
  <i class="fa-solid fa-user-group me-1"></i><i id="drawerIcon" class="fa-solid fa-angles-right"></i>
</button>

<!-- ===== Modals（沿用） ===== -->
<!-- 編輯時段 Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editSlotForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-1"></i>編輯時段</h5>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body row g-2">
          <input type="hidden" id="editSlotIndex">
          <div class="col-12">
            <label class="form-label">專案名稱</label>
            <input type="text" id="editProject" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label">時段名稱</label>
            <input type="text" id="editTitle" class="form-control" placeholder="例如：開場、典禮、彩排…">
          </div>
          <div class="col-6">
            <label class="form-label">日期</label>
            <input type="date" id="editDate" class="form-control" required>
          </div>
          <div class="col-3">
            <label class="form-label">開始</label>
            <input type="time" id="editStart" class="form-control" required>
          </div>
          <div class="col-3">
            <label class="form-label">結束</label>
            <input type="time" id="editEnd" class="form-control" required>
          </div>
          <div class="col-12 mt-1">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="editAllowDup">
              <label class="form-check-label" for="editAllowDup">允許同時段重複人員</label>
            </div>
          </div>
          <div class="col-12 small-muted">儲存後會依「日期 + 開始時間」重新排序。</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-ban"></i> 取消</button>
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> 儲存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 專案人員設定 Modal -->
<div class="modal fade" id="projectPeopleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="projectPeopleForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-user-group me-1"></i>設定本專案人員</h5>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <div class="small-muted mb-2">每行一個姓名；只會在此專案的人員池顯示。若移除某人，該人在此專案的指派會被清空。</div>
          <textarea id="projectPeopleText" class="form-control" rows="10" placeholder="每行一個姓名"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-ban"></i> 取消</button>
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> 儲存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 本專案時段設定 Modal（批次替換） -->
<div class="modal fade" id="projectSlotsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="projectSlotsForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-table-list me-1"></i>設定本專案時段（批次替換）</h5>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning p-2">
            <i class="fa-solid fa-triangle-exclamation me-1"></i>
            儲存後會<strong>替換</strong>目前專案的所有時段（會清除該專案原有職位與指派）。請先匯出或儲存備份。
          </div>
          <div class="small-muted mb-2">
            每行格式：<code>YYYY-MM-DD, HH:mm, HH:mm, 時段名稱</code><br>
            例：<code>2025-10-25, 09:00, 10:00, 開場</code>
          </div>
          <textarea id="projectSlotsText" class="form-control" rows="12" placeholder="2025-10-25, 09:00, 10:00, 開場&#10;2025-10-25, 10:10, 11:00, 典禮"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-ban"></i> 取消</button>
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> 儲存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 單一時段：設定職位與人員（多人以 ; 或 | 分隔） -->
<div class="modal fade" id="slotRolesPeopleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="slotRolesPeopleForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-clipboard-list me-1"></i>設定職位與人員</h5>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <div class="small-muted mb-2">
            請以「<b>職位,人名</b>」一行一筆；人名可留空。多人用 <code>;</code> 或 <code>|</code> 分隔。<br>
            例：<code>主持,張三;李四</code>、<code>攝影,</code>
          </div>
          <textarea id="slotRolesPeopleText" class="form-control" rows="12" placeholder="主持,張三;李四&#10;攝影,王五&#10;導播,"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-ban"></i> 取消</button>
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> 儲存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 個人安排 Modal -->
<div class="modal fade" id="personModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-user me-1"></i><span id="personModalName"></span> 的本專案安排</h5>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr><th>專案</th><th>時段名稱</th><th>日期</th><th>時間</th><th>職位</th></tr>
            </thead>
            <tbody id="personModalBody"></tbody>
          </table>
        </div>
        <div id="personModalEmpty" class="small text-muted">此人在本專案尚未被指派。</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ==== 0) 全域狀態：編輯職位模式 ==== */
let editRolesEnabled = true;

/* ==== 1) 預設人員清單 ==== */
const DEFAULT_PEOPLE = [
  "劉忠語","柯升硯","吳妍慧","柯知澈","蔡昀哲","邱炫瑋","邱思榕","吳宇樺","江鎮庭",
  "陳翔凡","周昱廷","彭元寬","辛昀諮","郭羽軒","葉祖妤","郭宜蓉","范祐綸","許為怡",
  "謝岳倫","謝沅江","江柏慶","蕭竹芮","黃晶","蔡宜真"
];

/* ==== 2) 資料結構 ==== */
let SLOTS = [
  { project:"37全縣大露營", title:"模組活動", date:"2025-11-19", start:"09:00", end:"10:00", roles:["主持","攝影","導播","音控"], allowDupInSlot:false },
  { project:"37全縣大露營", title:"大地遊戲", date:"2025-11-20", start:"08:00", end:"10:00", roles:["主持","攝影","導播","場控"], allowDupInSlot:true },
  { project:"37全縣大露營", title:"開幕典禮", date:"2025-11-20", start:"10:00", end:"11:00", roles:["主持","攝影","導播","招待"], allowDupInSlot:false }
];
// assignments[slotIdx][roleIdx] = string[]（同職位可多人）
let assignments = [];
let PROJECT_PEOPLE = {};
let focusIdx = 0;

/* ==== 3) 工具 ==== */
function slotKey(s){ return `${s.date} ${s.start}`; }
function timeLabel(s){ return `${s.date}　${s.start}–${s.end}`; }
function sortSlots(){
  const zipped = SLOTS.map((s,i)=>({s,i}));
  zipped.sort((a,b)=> slotKey(a.s).localeCompare(slotKey(b.s)));
  const newS=[], newA=[];
  zipped.forEach(z=>{
    newS.push(z.s);
    const oldArr = assignments[z.i] ?? Array(z.s.roles.length).fill(null).map(()=>[]);
    newA.push(normalizeAssignArray(z.s, oldArr));
  });
  SLOTS=newS; assignments=newA;
}
function normalizeAssignArray(slot, arr){
  const res = (arr||[]).map(x=> Array.isArray(x) ? x.slice() : (x ? [x] : []));
  while(res.length < slot.roles.length) res.push([]);
  if(res.length > slot.roles.length) res.length = slot.roles.length;
  return res;
}
function groupByDate(){
  const m = {};
  SLOTS.forEach((s, i)=>{
    if(!m[s.date]) m[s.date]=[];
    m[s.date].push({slot:s, idx:i});
  });
  return m;
}
function getPeopleForProject(project){
  if(!PROJECT_PEOPLE[project]) PROJECT_PEOPLE[project] = [...DEFAULT_PEOPLE];
  return PROJECT_PEOPLE[project];
}

/* ==== 3.1) 人員池智慧更新 ==== */
function ensurePoolHas(name){
  const s = SLOTS[focusIdx]; if(!s) return;
  const list = getPeopleForProject(s.project);
  if(!list.includes(name)) return;
  if($(`#peoplePool .people-item[data-person="${name}"]`).length===0){
    $("#peoplePool").append(personChip(name));
    applyDraggableToAllChips();
  }
}
function removePoolChip(name){
  $(`#peoplePool .people-item[data-person="${name}"]`).remove();
}
function updatePoolChipVisibilityFor(slotIdx, name){
  if(focusIdx !== slotIdx) return;
  const s = SLOTS[slotIdx]; if(!s) return;
  const used = personAlreadyInSlot(name, slotIdx);
  if(s.allowDupInSlot){ ensurePoolHas(name); }
  else{ if(used) removePoolChip(name); else ensurePoolHas(name); }
}

/* ==== 4) DOM & 互動 ==== */
function personChip(name){
  const $el = $(`<div class="people-item" draggable="true" data-person="${name}">
      <button class="btn btn-light btn-sm" title="退回人員池"><i class="fa-solid fa-xmark"></i></button>
      <span>${name}</span>
    </div>`);

  // 拖拉只在編輯模式開啟時啟用；但「點擊＝檢視安排」永遠有效（含檢視模式）
  $el.on("dragstart", function(e){
    if(!editRolesEnabled){ e.preventDefault(); return; }
    dragStart.call(this, e);
  });

  // 點擊 → 一律開個人安排（檢視模式也可以）
  $el.on("click", function(){
    const who = $(this).data("person");
    openPersonModal(who);
  });

  // 雙擊 / 叉叉 → 僅在可編輯時才允許
  $el.on("dblclick", function(){
    if(!editRolesEnabled) return;
    moveChipToPool($(this));
  });
  $el.find("button").on("click", (e)=>{
    e.stopPropagation();
    if(!editRolesEnabled) return;
    moveChipToPool($el);
  });

  if(!editRolesEnabled){
    $el.attr("draggable", false).addClass("nodrag");
    $el.find("button").hide();
  }else{
    $el.attr("draggable", true).removeClass("nodrag");
    $el.find("button").show();
  }
  return $el;
}

function applyDraggableToAllChips(){
  $(".people-item").each(function(){
    const $chip=$(this);
    if(!editRolesEnabled){
      $chip.attr("draggable", false).addClass("nodrag");
      $chip.find("button").hide();
    }else{
      $chip.attr("draggable", true).removeClass("nodrag");
      $chip.find("button").show();
    }
  });
}

function buildPeoplePool(){
  const pool = $("#peoplePool").empty();
  const s = SLOTS[focusIdx]; if(!s) return;
  const list = getPeopleForProject(s.project);
  const used = new Set();
  if(!s.allowDupInSlot){
    (assignments[focusIdx] || []).forEach(arr => (arr||[]).forEach(n => used.add(n)));
  }
  list.forEach(n=>{
    if(s.allowDupInSlot || !used.has(n)){
      pool.append(personChip(n));
    }
  });
  applyDraggableToAllChips();
}

function buildSlotList(){
  const host = $("#slotList").empty();
  const byDate = groupByDate();
  const dates = Object.keys(byDate).sort();
  dates.forEach(d=>{
    host.append(`<div class="small text-muted mb-1">${d}</div>`);
    const ul = $(`<div class="list-group list-group-flush mb-3"></div>`);
    byDate[d].forEach(({slot, idx})=>{
      const a = $(`
        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${idx===focusIdx?'active':''}" data-slot="${idx}">
          <span class="text-start">
            <span class="badge text-bg-secondary slot-badge me-1"><i class="fa-solid fa-folder-closed me-1"></i>${slot.project || "未命名專案"}</span>
            <span class="badge text-bg-info slot-badge me-1"><i class="fa-solid fa-tag me-1"></i>${slot.title || "（無時段名）"}</span>
            <i class="fa-solid fa-clock me-1"></i>${slot.start}–${slot.end}
          </span>
          <span class="badge ${slot.allowDupInSlot ? 'text-bg-warning' : 'bg-dark'}">
            ${slot.allowDupInSlot ? '允重複' : `<i class="fa-solid fa-user-gear me-1"></i>${slot.roles.length}`}
          </span>
        </button>`);
      a.on("click", ()=>{ focusIdx = idx; renderFocus(); buildSlotList(); buildPeoplePool(); });
      ul.append(a);
    });
    host.append(ul);
  });
}

function buildAssignmentsStruct(){
  assignments = SLOTS.map(s=> Array(s.roles.length).fill(null).map(()=>[]));
}

function renderFocus(){
  const s = SLOTS[focusIdx];
  $("#focusProject").text(s ? (s.project || "未命名專案") : "");
  $("#focusTitle").text(s ? (s.title || "（無時段名）") : "");
  $("#focusTime").text(s ? timeLabel(s) : "無");
  $("#focusDup").text(s?.allowDupInSlot ? "允許同時段重複人員" : "同時段不可重複人員");
  $("#focusEditMode")
    .text(editRolesEnabled ? "編輯模式" : "檢視模式")
    .removeClass("text-bg-secondary text-bg-success")
    .addClass(editRolesEnabled ? "text-bg-success" : "text-bg-secondary");

  const grid = $("#roleGrid").empty();
  if(!s || s.roles.length===0){ $("#emptyHint").show(); return; }
  $("#emptyHint").hide();

  s.roles.forEach((role, rIdx)=>{
    const actions = editRolesEnabled ? `
          <button class="icon-btn" title="改名" data-rename="${rIdx}"><i class="fa-solid fa-pen"></i></button>
          <button class="icon-btn" title="刪除此職位" data-del="${rIdx}"><i class="fa-solid fa-trash"></i></button>
        ` : ``;

    const card = $(`
      <div class="role-card">
        <div class="role-title">
          <span class="fw-semibold me-auto"><i class="fa-solid fa-briefcase me-1"></i>${role}</span>
          ${actions}
        </div>
        <div class="drop-box" data-drop="role" data-slot-idx="${focusIdx}" data-role-idx="${rIdx}">
          <div class="role-empty"><i class="fa-regular fa-hand-pointer me-1"></i>${editRolesEnabled ? '拖曳人員到這裡' : '目前為檢視模式'}</div>
        </div>
      </div>
    `);
    grid.append(card);
  });

  (assignments[focusIdx] || []).forEach((arr, rIdx)=>{
    const box = $(`[data-slot-idx="${focusIdx}"][data-role-idx="${rIdx}"]`);
    box.empty();
    const list = (arr||[]);
    if(list.length===0){
      box.append(`<div class="role-empty"><i class="fa-regular fa-hand-pointer me-1"></i>${editRolesEnabled ? '拖曳人員到這裡' : '目前為檢視模式'}</div>`);
    }else{
      list.forEach(name => box.append(personChip(name)));
    }
  });

  if(editRolesEnabled){
    $("#roleGrid").find("[data-rename]").on("click", function(){
      const r = +$(this).data("rename");
      const cur = SLOTS[focusIdx].roles[r];
      const n = prompt("修改職位名稱：", cur);
      if(n && n.trim()){
        SLOTS[focusIdx].roles[r] = n.trim();
        renderFocus(); buildSlotList();
      }
    });
    $("#roleGrid").find("[data-del]").on("click", function(){
      const r = +$(this).data("del");
      const roleName = SLOTS[focusIdx].roles[r];
      if(!confirm(`確定刪除職位「${roleName}」？`)) return;
      (assignments[focusIdx][r]||[]).forEach(n=> moveNameToPoolDOM(n));
      SLOTS[focusIdx].roles.splice(r,1);
      assignments[focusIdx].splice(r,1);
      renderFocus(); buildSlotList(); buildPeoplePool();
    });
  }

  enableDnD();
  applyDraggableToAllChips();
}

/* ==== 5) 拖放規則 ==== */
let dragData=null;
function dragStart(e){
  const name = $(this).data("person");
  dragData = { name, from: findParentBox(this) };
  e.originalEvent.dataTransfer.setData("text/plain", name);
}
function findParentBox(el){
  const $el=$(el);
  const roleBox = $el.closest(".drop-box");
  if(roleBox.length){
    return { type:"role", slotIdx:+roleBox.data("slot-idx"), roleIdx:+roleBox.data("role-idx") };
  }
  return { type:"pool" };
}
function enableDnD(){
  $("[data-drop]").each(function(){
    this.addEventListener("dragover", ev=>{
      if(!editRolesEnabled) return;
      ev.preventDefault(); $(this).addClass("dropping");
    });
    this.addEventListener("dragleave", ev=>{ $(this).classList && $(this).classList.remove("dropping"); });
    this.addEventListener("drop", ev=>{
      $(this).classList && $(this).classList.remove("dropping");
      if(!editRolesEnabled) return;
      ev.preventDefault();
      const t = this.dataset.drop;
      const name = dragData?.name;
      if(!name) return;
      if(t==="pool"){ moveToPool(name); }
      else if(t==="role"){
        const sIdx = +this.dataset.slotIdx;
        const rIdx = +this.dataset.roleIdx;
        assignToRole(name, sIdx, rIdx);
      }
      dragData=null;
    });
  });
}

function personAlreadyInSlot(name, sIdx){
  const arr = assignments[sIdx] || [];
  for(const list of arr) if((list||[]).includes(name)) return true;
  return false;
}

function assignToRole(name, sIdx, rIdx){
  const allowDup = !!SLOTS[sIdx].allowDupInSlot;
  const isFromRole = dragData?.from?.type==="role";
  const fromSlotIdx = isFromRole ? dragData.from.slotIdx : -1;
  const fromRoleIdx = isFromRole ? dragData.from.roleIdx : -1;
  const isMoveWithinSameSlot = isFromRole && (fromSlotIdx === sIdx);

  if(isMoveWithinSameSlot && fromRoleIdx === rIdx) return;

  if(isMoveWithinSameSlot){
    const srcList = assignments[sIdx][fromRoleIdx] || [];
    const p = srcList.indexOf(name);
    if(p>-1) srcList.splice(p,1);
    assignments[sIdx][fromRoleIdx] = srcList;
    const srcBox = $(`[data-slot-idx="${sIdx}"][data-role-idx="${fromRoleIdx}"]`).empty();
    if(srcList.length===0){
      srcBox.append(`<div class="role-empty"><i class="fa-regular fa-hand-pointer me-1"></i>${editRolesEnabled ? '拖曳人員到這裡' : '目前為檢視模式'}</div>`);
    }else{
      srcList.forEach(n=> srcBox.append(personChip(n)));
    }
    updatePoolChipVisibilityFor(sIdx, name);
  }else{
    if(!allowDup && personAlreadyInSlot(name, sIdx)){
      alert(`此時段已指派 ${name} 到其他職位（本時段不允許重複人員）。`);
      return;
    }
    if(isFromRole && fromSlotIdx !== sIdx){
      const src = assignments[fromSlotIdx][fromRoleIdx] || [];
      const p = src.indexOf(name);
      if(p>-1) src.splice(p,1);
      assignments[fromSlotIdx][fromRoleIdx] = src;
      const srcBox = $(`[data-slot-idx="${fromSlotIdx}"][data-role-idx="${fromRoleIdx}"]`).empty();
      if(src.length===0){
        srcBox.append(`<div class="role-empty"><i class="fa-regular fa-hand-pointer me-1"></i>${editRolesEnabled ? '拖曳人員到這裡' : '目前為檢視模式'}</div>`);
      }else{
        src.forEach(n=> srcBox.append(personChip(n)));
      }
      updatePoolChipVisibilityFor(fromSlotIdx, name);
    }
  }

  const list = assignments[sIdx][rIdx] || [];
  if(list.includes(name)){
    alert(`職位「${SLOTS[sIdx].roles[rIdx]}」已包含 ${name}。`);
    return;
  }

  list.push(name);
  assignments[sIdx][rIdx] = list;

  const box = $(`[data-slot-idx="${sIdx}"][data-role-idx="${rIdx}"]`).empty();
  (assignments[sIdx][rIdx]||[]).forEach(n => box.append(personChip(n)));

  updatePoolChipVisibilityFor(sIdx, name);

  if(dragData?.from?.type==="pool"){
    if(!allowDup && focusIdx === sIdx){
      removePoolChip(name);
    }
  }
}

function moveToPool(name){
  if(dragData?.from?.type==="role"){
    const {slotIdx, roleIdx} = dragData.from;
    const L = assignments[slotIdx][roleIdx] || [];
    const pos = L.indexOf(name);
    if(pos>-1) L.splice(pos,1);
    const box = $(`[data-slot-idx="${slotIdx}"][data-role-idx="${roleIdx}"]`).empty();
    if((assignments[slotIdx][roleIdx]||[]).length===0){
      box.append(`<div class="role-empty"><i class="fa-regular fa-hand-pointer me-1"></i>${editRolesEnabled ? '拖曳人員到這裡' : '目前為檢視模式'}</div>`);
    }else{
      (assignments[slotIdx][roleIdx]||[]).forEach(n=> box.append(personChip(n)));
    }
    updatePoolChipVisibilityFor(slotIdx, name);
  }
}

function moveChipToPool($chip){
  const name = $chip.data("person");
  const roleBox = $chip.closest(".drop-box");
  if(roleBox.length){
    const sIdx = +roleBox.data("slot-idx");
    const rIdx = +roleBox.data("role-idx");
    const L = assignments[sIdx][rIdx] || [];
    const pos = L.indexOf(name);
    if(pos>-1) L.splice(pos,1);
    roleBox.empty();
    if(L.length===0){
      roleBox.append(`<div class="role-empty"><i class="fa-regular fa-hand-pointer me-1"></i>${editRolesEnabled ? '拖曳人員到這裡' : '目前為檢視模式'}</div>`);
    }else{
      L.forEach(n=> roleBox.append(personChip(n)));
    }
    updatePoolChipVisibilityFor(sIdx, name);
  }
  $chip.remove();
}

function moveNameToPoolDOM(name){ ensurePoolHas(name); }

/* ==== 6) 個人安排 Modal ==== */
function openPersonModal(who){
  const s = SLOTS[focusIdx]; if(!s) return;
  const pj = s.project;
  $("#personModalName").text(who);
  const body = $("#personModalBody").empty();
  let has=false;
  SLOTS.forEach((slot, i)=>{
    if(slot.project !== pj) return;
    (assignments[i]||[]).forEach((arr, rIdx)=>{
      (arr||[]).forEach(n=>{
        if(n===who){
          has=true;
          body.append(`<tr>
            <td>${slot.project || "未命名專案"}</td>
            <td>${slot.title || "（無時段名）"}</td>
            <td>${slot.date}</td>
            <td>${slot.start}–${slot.end}</td>
            <td>${slot.roles[rIdx] || ""}</td>
          </tr>`);
        }
      });
    });
  });
  $("#personModalEmpty").toggle(!has);
  new bootstrap.Modal(document.getElementById('personModal')).show();
}

/* ==== 7) 專案人員設定 ==== */
function openProjectPeopleModal(){
  const s = SLOTS[focusIdx]; if(!s) { alert("請先建立並選取一個時段。"); return; }
  const list = getPeopleForProject(s.project);
  $("#projectPeopleText").val(list.join("\n"));
  new bootstrap.Modal(document.getElementById('projectPeopleModal')).show();
}
function saveProjectPeople(){
  const s = SLOTS[focusIdx]; if(!s) return;
  const raw = $("#projectPeopleText").val().split("\n").map(x=>x.trim()).filter(Boolean);
  const uniq = [...new Set(raw)];
  PROJECT_PEOPLE[s.project] = uniq;

  SLOTS.forEach((slot, i)=>{
    if(slot.project !== s.project) return;
    (assignments[i]||[]).forEach((arr, rIdx)=>{
      assignments[i][rIdx] = (arr||[]).filter(n => uniq.includes(n));
    });
  });

  renderFocus();
  buildPeoplePool();
  bootstrap.Modal.getInstance(document.getElementById('projectPeopleModal')).hide();
}

/* ==== 8) 本專案時段設定（批次替換） ==== */
function openProjectSlotsModal(){
  const s = SLOTS[focusIdx];
  if(!s){ alert("請先建立並選取一個時段（以取得目標專案）。"); return; }
  const pj = s.project;
  const lines = [];
  SLOTS.forEach(ss=>{
    if(ss.project!==pj) return;
    lines.push(`${ss.date}, ${ss.start}, ${ss.end}, ${ss.title || ""}`.trim());
  });
  $("#projectSlotsText").val(lines.join("\n"));
  new bootstrap.Modal(document.getElementById('projectSlotsModal')).show();
}
function saveProjectSlots(){
  const s = SLOTS[focusIdx]; if(!s) return;
  const pj = s.project;
  const text = $("#projectSlotsText").val().trim();
  if(!text){ alert("請輸入至少一行時段。"); return; }

  const rows = text.split("\n").map(l=>l.trim()).filter(Boolean);
  const parsed = [];
  const re = /^(\d{4}-\d{2}-\d{2})\s*,\s*(\d{2}:\d{2})\s*,\s*(\d{2}:\d{2})\s*,\s*(.+)$/;

  for(let i=0;i<rows.length;i++){
    const m = rows[i].match(re);
    if(!m){ alert(`第 ${i+1} 行格式錯誤，應為：YYYY-MM-DD, HH:mm, HH:mm, 時段名稱`); return; }
    const [_, date, start, end, title] = m;
    if(start>=end){ alert(`第 ${i+1} 行：開始需早於結束`); return; }
    parsed.push({project: pj, title: title.trim(), date, start, end, roles: [], allowDupInSlot: false});
  }

  if(!confirm(`將以 ${rows.length} 個時段「替換」專案「${pj}」的所有時段與指派，確定嗎？`)) return;

  const keepS=[], keepA=[];
  for(let i=0;i<SLOTS.length;i++){
    if(SLOTS[i].project!==pj){ keepS.push(SLOTS[i]); keepA.push(assignments[i]||[]); }
  }
  SLOTS = keepS;
  assignments = keepA;

  parsed.forEach(obj=>{
    SLOTS.push(obj);
    assignments.push([]);
  });

  sortSlots();
  focusIdx = SLOTS.findIndex(x=> x.project===pj);
  rebuildAll();
  bootstrap.Modal.getInstance(document.getElementById('projectSlotsModal')).hide();
}

/* ==== 9) 單一時段：設定職位與人員（多人以 ; 或 | 分隔） ==== */
function openSlotRolesPeopleModal(){
  const s = SLOTS[focusIdx]; if(!s) return;
  let lines = [];
  const list = s.roles;
  const arr = assignments[focusIdx] || [];
  for(let i=0;i<list.length;i++){
    const persons = (arr[i]||[]).join(";");
    lines.push(`${list[i]},${persons}`);
  }
  $("#slotRolesPeopleText").val(lines.join("\n"));
  new bootstrap.Modal(document.getElementById('slotRolesPeopleModal')).show();
}
function saveSlotRolesPeople(){
  const s = SLOTS[focusIdx]; if(!s) return;
  const projectList = getPeopleForProject(s.project);
  const lines = $("#slotRolesPeopleText").val().split("\n").map(x=>x.trim()).filter(Boolean);

  const newRoles = [];
  const newAssign = [];
  const seenInSlot = new Set();
  const allowDup = !!s.allowDupInSlot;

  for(const line of lines){
    const idx = line.indexOf(",");
    let role = "", personsRaw = "";
    if(idx===-1){ role = line.trim(); personsRaw = ""; }
    else { role = line.slice(0, idx).trim(); personsRaw = line.slice(idx+1).trim(); }
    if(!role){ alert("有一行缺少職位名稱，請修正後再儲存。"); return; }

    let people = personsRaw
      ? personsRaw.split(/[,;|]/).map(x=>x.trim()).filter(Boolean)
      : [];
    const uniqueRoleSet = new Set();
    for(const p of people){
      if(!projectList.includes(p)){ alert(`「${p}」不在此專案人員名單中，請先到「設定本專案人員」加入。`); return; }
      if(uniqueRoleSet.has(p)){ alert(`同一職位不可重複同一人：${p}`); return; }
      uniqueRoleSet.add(p);
      if(!allowDup && seenInSlot.has(p)){ alert(`同一時段不可重複指派同一人：${p}`); return; }
    }
    if(!allowDup) people.forEach(p=>seenInSlot.add(p));

    newRoles.push(role);
    newAssign.push(people);
  }

  SLOTS[focusIdx].roles = newRoles;
  assignments[focusIdx] = newAssign;

  renderFocus();
  buildSlotList();
  buildPeoplePool();
  bootstrap.Modal.getInstance(document.getElementById('slotRolesPeopleModal')).hide();
}

/* ==== 10) 匯出（JSON / CSV） ==== */
function toCSV(){
  const header = ["專案","時段名稱","日期","開始","結束","職位","人員"];
  const rows = [header];
  SLOTS.forEach((s, i)=>{
    const arr = assignments[i] || [];
    s.roles.forEach((role, rIdx)=>{
      const persons = (arr[rIdx]||[]).join(" / ");
      rows.push([s.project || "", s.title || "", s.date || "", s.start || "", s.end || "", role || "", persons]);
    });
  });
  const esc = (v)=> {
    const str = (v ?? "").toString();
    if(/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
    return str;
  };
  const csv = rows.map(r=> r.map(esc).join(",")).join("\n");
  return "\uFEFF" + csv;
}

/* ==== 11) 一般控制 ==== */
function rebuildAll(){
  sortSlots();
  buildSlotList();
  renderFocus();
  buildPeoplePool();
  applyEditRolesMode();
}
function openEditSlotModal(idx){
  $("#editSlotIndex").val(idx);
  $("#editProject").val(SLOTS[idx].project || "");
  $("#editTitle").val(SLOTS[idx].title || "");
  $("#editDate").val(SLOTS[idx].date);
  $("#editStart").val(SLOTS[idx].start);
  $("#editEnd").val(SLOTS[idx].end);
  $("#editAllowDup").prop("checked", !!SLOTS[idx].allowDupInSlot);
  new bootstrap.Modal(document.getElementById('editSlotModal')).show();
}

/* 11.1 編輯模式套用 */
function applyEditRolesMode(){
  $("#btnAddRole").prop("disabled", !editRolesEnabled);
  $("#btnSlotRolesPeople").prop("disabled", !editRolesEnabled);
  $("#focusEditMode")
    .text(editRolesEnabled ? "編輯模式" : "檢視模式")
    .removeClass("text-bg-secondary text-bg-success")
    .addClass(editRolesEnabled ? "text-bg-success" : "text-bg-secondary");
  applyDraggableToAllChips();
}

/* ==== 12) 右欄顯示/隱藏 ==== */
let rightVisible = true;
function applyLayoutByRightVisibility(){
  const $left = $("#leftCol"), $center = $("#centerCol"), $right = $("#rightCol");
  if(rightVisible){
    $right.removeClass("d-none");
    $left.removeClass("col-lg-4").addClass("col-lg-3");
    $center.removeClass("col-lg-8").addClass("col-lg-6");
    $("#drawerIcon").removeClass("fa-angles-left").addClass("fa-angles-right");
  }else{
    $right.addClass("d-none");
    $left.removeClass("col-lg-3").addClass("col-lg-4");
    $center.removeClass("col-lg-6").addClass("col-lg-8");
    $("#drawerIcon").removeClass("fa-angles-right").addClass("fa-angles-left");
  }
}
$("#drawerHandle").on("click", function(){
  rightVisible = !rightVisible;
  applyLayoutByRightVisibility();
});

/* ==== 13) 綁定事件 ==== */
$("#btnProjectPeople").on("click", openProjectPeopleModal);
$("#projectPeopleForm").on("submit", function(e){ e.preventDefault(); saveProjectPeople(); });

$("#btnProjectSlots").on("click", openProjectSlotsModal);
$("#projectSlotsForm").on("submit", function(e){ e.preventDefault(); saveProjectSlots(); });

$("#btnSlotRolesPeople").on("click", function(){
  if(!editRolesEnabled){ alert("目前為檢視模式，請先開啟「編輯職位」。"); return; }
  openSlotRolesPeopleModal();
});
$("#slotRolesPeopleForm").on("submit", function(e){ e.preventDefault(); saveSlotRolesPeople(); });

$("#btnAddRole").on("click", ()=>{
  if(!editRolesEnabled){ alert("目前為檢視模式，請先開啟「編輯職位」。"); return; }
  if(!SLOTS.length) return;
  const name = prompt("新增職位名稱：");
  if(!name) return;
  SLOTS[focusIdx].roles.push(name.trim());
  assignments[focusIdx].push([]);
  renderFocus(); buildSlotList(); applyEditRolesMode();
});
$("#btnEditSlot").on("click", ()=> { if(SLOTS.length) openEditSlotModal(focusIdx); });
$("#btnDelSlot").on("click", ()=>{
  if(!SLOTS.length) return;
  const label=`${SLOTS[focusIdx].project || '專案'}｜${SLOTS[focusIdx].title || '時段'}｜${timeLabel(SLOTS[focusIdx])}`;
  if(!confirm(`刪除時段：${label}？`)) return;
  (assignments[focusIdx]||[]).forEach(L => (L||[]).forEach(n => moveNameToPoolDOM(n)));
  SLOTS.splice(focusIdx,1);
  assignments.splice(focusIdx,1);
  focusIdx = Math.max(0, focusIdx-1);
  rebuildAll();
});

/* 左欄：編輯職位開關 */
$("#toggleEditRoles").on("change", function(){
  editRolesEnabled = $(this).is(":checked");
  applyEditRolesMode();
  renderFocus();
});

/* 一致的 LS_KEY */
const LS_KEY = "dragRoster.pwa.smartpool.editToggle.navbar.v6";

/* 表單：編輯 / 新增時段 */
$("#editSlotForm").on("submit", function(e){
  e.preventDefault();
  const idx = +$("#editSlotIndex").val();
  const pj = $("#editProject").val().trim();
  const tl = $("#editTitle").val().trim();
  const d  = $("#editDate").val();
  const st = $("#editStart").val();
  const ed = $("#editEnd").val();
  const dup = $("#editAllowDup").is(":checked");
  if(!pj || !d || !st || !ed) return;
  if(st>=ed){ alert("結束時間需大於開始時間"); return; }
  SLOTS[idx].project=pj; SLOTS[idx].title=tl; SLOTS[idx].date=d; SLOTS[idx].start=st; SLOTS[idx].end=ed; SLOTS[idx].allowDupInSlot=dup;
  getPeopleForProject(pj);
  sortSlots();
  focusIdx = SLOTS.findIndex(s=> s.project===pj && s.title===tl && s.date===d && s.start===st && s.end===ed);
  rebuildAll();
  bootstrap.Modal.getInstance(document.getElementById('editSlotModal')).hide();
});

$("#addForm").on("submit", function(e){
  e.preventDefault();
  const pj=$("#inpProject").val().trim();
  const tl=$("#inpTitle").val().trim();
  const d =$("#inpDate").val(), st=$("#inpStart").val(), ed=$("#inpEnd").val();
  const rs=$("#inpRoles").val().split(",").map(x=>x.trim()).filter(Boolean);
  const dup=$("#inpAllowDup").is(":checked");
  if(!pj || !d||!st||!ed) return alert("請輸入專案/日期/時間");
  if(st>=ed) return alert("結束時間需大於開始時間");
  SLOTS.push({project:pj, title:tl, date:d, start:st, end:ed, roles:rs, allowDupInSlot:dup});
  assignments.push(rs.map(()=>[]));
  getPeopleForProject(pj);
  sortSlots();
  focusIdx = SLOTS.findIndex(s=> s.project===pj && s.title===tl && s.date===d && s.start===st && s.end===ed);
  rebuildAll();

  // 清空表單（保持收合狀態不變）
  $("#inpProject, #inpTitle, #inpDate, #inpStart, #inpEnd, #inpRoles").val("");
  $("#inpAllowDup").prop("checked", false);
});

/* Navbar 工具：儲存/載入/匯出/匯入/清空 */
$("#btnSave").on("click", ()=>{ localStorage.setItem(LS_KEY, JSON.stringify(getSnapshot())); alert("已儲存"); });
$("#btnLoad").on("click", ()=>{
  const txt = localStorage.getItem(LS_KEY);
  if(!txt) return alert("尚無儲存資料");
  setSnapshot(JSON.parse(txt)) ? alert("已載入") : alert("格式不符");
});
$("#btnExportJSON").on("click", ()=>{
  const blob=new Blob([JSON.stringify(getSnapshot(),null,2)], {type:"application/json"});
  const url=URL.createObjectURL(blob), a=document.createElement("a");
  a.href=url; a.download="roster.json"; a.click(); URL.revokeObjectURL(url);
});
$("#btnExportCSV").on("click", ()=>{
  const csv = toCSV();
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "roster.csv"; a.click();
  URL.revokeObjectURL(url);
});
$("#importFile").on("change", function(){
  const f=this.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{ setSnapshot(JSON.parse(r.result)) ? alert("匯入完成") : alert("匯入失敗"); }
    catch{ alert("匯入失敗：非 JSON 或格式錯誤"); }
  };
  r.readAsText(f,'utf-8'); this.value="";
});
$("#btnClear").on("click", ()=>{
  if(!confirm("清空所有安排？")) return;
  assignments = SLOTS.map(s=> Array(s.roles.length).fill(null).map(()=>[]));
  rebuildAll();
});

/* Collapse 圖示同步（新增時段） */
document.addEventListener('DOMContentLoaded', function(){
  const el = document.getElementById('addCollapse');
  if(el){
    el.addEventListener('shown.bs.collapse', ()=> $('#addCollapseIcon').removeClass('fa-chevron-down').addClass('fa-chevron-up'));
    el.addEventListener('hidden.bs.collapse', ()=> $('#addCollapseIcon').removeClass('fa-chevron-up').addClass('fa-chevron-down'));
  }
});

/* ==== 14) 初始化（PWA 註冊） ==== */
$(function(){
  assignments = SLOTS.map(s=> Array(s.roles.length).fill(null).map(()=>[]));
  sortSlots();
  if(SLOTS.length) getPeopleForProject(SLOTS[0].project);
  buildSlotList();
  renderFocus();
  buildPeoplePool();
  applyLayoutByRightVisibility();

  // PWA：註冊 Service Worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{ /* 忽略錯誤 */ });
  }
});

/* 小工具與快照 */
function moveToPoolDOM(name){ moveNameToPoolDOM(name); }
function getSnapshot(){ return {SLOTS, assignments, PROJECT_PEOPLE, focusIdx, editRolesEnabled}; }
function setSnapshot(snap){
  if(!snap || !Array.isArray(snap.SLOTS) || !Array.isArray(snap.assignments)) return false;
  SLOTS = snap.SLOTS.map(s => ({...s, allowDupInSlot: !!s.allowDupInSlot}));
  PROJECT_PEOPLE = snap.PROJECT_PEOPLE || {};
  assignments = snap.assignments.map((arr, idx)=> normalizeAssignArray(SLOTS[idx], arr));
  focusIdx = Math.min(snap.focusIdx ?? 0, SLOTS.length-1);
  editRolesEnabled = (snap.editRolesEnabled !== undefined) ? !!snap.editRolesEnabled : true;
  $('#toggleEditRoles').prop('checked', editRolesEnabled);
  rebuildAll();
  applyEditRolesMode();
  return true;
}
</script>

<!-- 只載一次 Bootstrap Bundle（含 Popper） -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
